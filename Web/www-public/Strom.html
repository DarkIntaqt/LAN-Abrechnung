<!DOCTYPE HTML>
<!--
	Hyperspace by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title id="SideTile"></title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Header -->
			<header id="header">
				<a href="index.html" id="HeaderWelcome" class="title"></a>
				<nav>
					<ul id="LinksList">
					</ul>
				</nav>
			</header>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<section id="main" class="wrapper">
						<div class="inner">
							<h1 class="major" id="MainHeadline"></h1>
							<h3 id="StromText"></h3>
							<div id="StromChart"> </div>
						</div>
					</section>

			</div>

		<!-- Footer -->
			<footer id="footer" class="wrapper alt">
				<div class="inner">
					<ul class="menu">
						<li>&copy; LAN-Manager by EBG.PW | All rights reserved.</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li><li>Projekt und Dokumentation: <a href="https://github.com/EBG-PW/LAN-Abrechnung">Github</a></li><li>
							<select id="countries" onchange='chanceLanguageEvent()' style="width:280px;">
								<option value='de'>ðŸ‡©ðŸ‡ª German</option>
								<option value='en'>ðŸ‡¬ðŸ‡§ English</option>
								<option value='it'>ðŸ‡®ðŸ‡¹ Italian</option>
								<option value='ua'>ðŸ‡ºðŸ‡¦ Ukranian</option>
							</select>
						</li>
					</ul>
				</div>
			</footer>

		<!-- Scripts -->
			<script>const exports = {};//Fixes i18n Stuff lol.</script>
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/verifyToken.js"></script>
			<script src="assets/js/apexcharts.js"></script>
			<script src="assets/js/i18n.source.js"></script>
			<script src="assets/js/i18n.js"></script>
			<script src="assets/js/jquery.scrollex.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			<script src="assets/js/BackendCalls.js"></script>
			<script src="assets/js/BuildHTML.js"></script>
			<script src="assets/js/table.js"></script>
			<script src="assets/js/strom_websocket.js"></script>
			<script src="assets/js/htmltables.js"></script>
			<script src="assets/js/buttons.js"></script>
			<script>
				CheckTokenValidity().then(function(TokenData) {
					//This will wirte all Token data to localstorrage to be used in all funktions
					writeTokenDataToLocalStorrage(TokenData)
					//Will create the header based on active and persmissions
					createHeaderLinks("Strom")
					//Will translate a key value to the language of the token
					createHeaderMessage()
					createSiteTitle()
					//Write transladed headline in Main wrapper
					$("#MainHeadline").html(translate('Header.Links.Strom'));
					GeTotalKWH().then(function(TotalKWH) {
						let powerChart;

						$("#StromText").html(translate('Stromseite.Text', {totalkwh: (TotalKWH.kwh).replace(".", ","), totalkostenkwh: CentToEuro(TotalKWH.kwh*TotalKWH.price)}));

						const webSocket = new WebSocket(`ws://${TotalKWH.url_websocket}/webuser`);
						let PowerGraphData = []

						webSocket.onerror = function(message) {
							console.log('WebSocket Error: ' + JSON.stringify(message));
						};
						
						webSocket.onopen = function(message) {
							webSocket.send(JSON.stringify({"event": "plug_gethistory", "data_payload": {"plugid": TotalKWH.plugid, "userid": TotalKWH.userid}}));
							webSocket.send(JSON.stringify({"event": "subscribe_plugid", "data_payload": {"plugid": TotalKWH.plugid, "userid": TotalKWH.userid}}));
						};

						webSocket.onmessage = function(message) {
							const message_data = JSON.parse(message.data);
    						const { event, data_payload } = message_data;
							if(event === 'plug_power'){
								PowerGraphData.push(data_payload.Power)
								if(powerChart.w.config.series[0].data.length >= Number(TotalKWH.graph_length)){
									//powerChart.w.config.series[0].data.shift() // Makes the chart wobbly... GH ISSUE OFFEN
								}

								console.log([...powerChart.w.config.series[0].data, [Date.now(), data_payload.Power]])
								
								powerChart.updateSeries([{
									data: [...powerChart.w.config.series[0].data, [Date.now(), data_payload.Power]]
								}])
								
								$("#StromText").html(translate('Stromseite.Text', {totalkwh: (((data_payload.TotalEnergy/ 1000)-TotalKWH.power_start).toFixed(3)).replace(".", ","), totalkostenkwh: CentToEuro(((data_payload.TotalEnergy/ 1000)-TotalKWH.power_start).toFixed(3)*TotalKWH.price)}));
								$("#MainHeadline").html(`${translate('Header.Links.Strom')}  |  ${data_payload.Power}W`);
							} else if (event === 'plug_history') {
								for(let i = 0; i < data_payload.length; i++) {
									PowerGraphData.push(data_payload[i].Power)
								}
								if(PowerGraphData.length < TotalKWH.graph_length) {
									for(let i = 0; i < Number(TotalKWH.graph_length)-Number(data_payload.length); i++) {
										PowerGraphData.push(0)
									}
								}

								CreateChart(PowerGraphData)
							}
						}

						function CreateChart(PowerGraphDataF) {
							let series = [];
							
							for(let i = 0; i < PowerGraphDataF.length; i++) {
								series.push([Date.now() - 1000 * i, PowerGraphDataF[i]]);
							}

							series.reverse();

							window.Apex = {
								chart: {
									foreColor: "#fff",
									toolbar: {
									show: false
									}
								},

								stroke: {
									width: 3
								},
								dataLabels: {
									enabled: false
								},
								grid: {
									borderColor: "#40475D"
								},
								xaxis: {
									axisTicks: {
									color: "#333"
									},
									axisBorder: {
									color: "#333"
									}
								},
								fill: {
									type: "gradient",
									gradient: {
										type: "vertical",
										gradientToColors: ["#F55555", "#fad932", "#2aa811"]
									}
								},
								yaxis: {
									decimalsInFloat: 2,
									opposite: true,
									labels: {
									offsetX: -10
									}
								}
							};

							const options = {
								series: [{
									data: series
								}],
								chart: {
									id: 'realtime',
									height: 350,
									type: 'line',
									animations: {
										enabled: true,
										easing: 'linear',
										dynamicAnimation: {
											speed: 1000
										}
									},
									toolbar: {
										show: false
									},
									zoom: {
										enabled: false
									}
								},
								dataLabels: {
									enabled: false
								},
								stroke: {
									curve: 'smooth'
								},
								markers: {
									size: 0
								},
								xaxis: {
									type: "datetime",
    								range: 60*1000
								},
								yaxis: {
									max: 600
								},
								legend: {
									show: false
								},
							};
							
							powerChart = new ApexCharts(document.getElementById('StromChart'), options);
							powerChart.render();
						}
					});
				})
			</script>
	</body>
	</body>
</html>